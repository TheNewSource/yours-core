<html>
<head>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script type="text/javascript" src="datt-node.js"></script>
<script type="text/javascript">

var bitcore = datt_node.bitcore;
var Peer = datt_node.Peer;

var Datt = datt_node.Datt;
var User = datt_node.User;
var Message = datt_node.Message;
var Content = datt_node.Content;
var ContentStore = datt_node.ContentStore;


var datt = null;
var contentStore = new ContentStore();
contentStore.init()
//var peers = new Webcoin.PeerGroup();
//peers.connect();


function writeToBody(txt) {
  var htmlSnippet = txt + "<br><br>";
  $("#data").html(htmlSnippet + $("#data").html());
}

function onOpen() {
  var txt = "Connected to rendezvous server.";
  $("#status").html(txt);
}

function onConnectionData(data, conn) {
  datt.onConnectionData(data)
  var htmlSnippet = "<span><strong>Peer '" + conn.peer +"' sent:</strong> " + JSON.stringify(data, null, 4) + "</span>";
  writeToBody(htmlSnippet);
  contentStore.getContent(data).then(function(content) {
    if(content){
      datt.broadcastMessage(content);
    }
  });
  return false
}

function dattLogin() {
  var username = $("#username").val();
  var password = $("#password").val();

  datt.signIn(username, password).then(function() {
    var user = datt.user;
    console.log("datt#signIn - callback executed with user: ");
    console.log(user);
    var txt = "User created with username: '<strong>" + user.username + "</strong>' and address '<strong>" + user.address + "</strong>'.";
    $("#user").html(txt);
  }).catch(function(err) {
    console.log('caught error ' + err)
  });

  return false;
}

function dattAddContent() {
  var content = $("#addcontent").val();
  datt.addContent(content).then(function (hashhex) {
    $("#addcontent").val("");
    writeToBody("Added " + content + " to storage with hash " + hashhex);
    datt.broadcastMessage("New content: " + hashhex);
  })
  return false;
}

function dattGetLocalContent() {
  var hash = $("#getlocalcontent").val();
  contentStore.getContent(hash).then(function (content) {
    $("#getlocalcontent").val("");
    writeToBody("<strong>Got local content:</strong> " + content.getData());
  });
  return false;
}

function dattGetRemoteContent() {
  var hash = $("#getremotecontent").val();
  $("#getremotecontent").val("");
  var content = datt.askPeersForContent(hash);
  return false;
}

function dattGetPeersForContent() {
  var hash = $("#getpeersforcontent").val();
  $("#getpeersforcontent").val("");
  datt.askPeersForPeersForContent(hash);
  //datt.broadcastMessage("Newhhhh: " + hash);
  return false;
}

function onPeers(peers) {
  var txt = "Got peers:<br>" + JSON.stringify(peers, null, 4);
  $("#peers").html(txt);
}

function whenConnectedToPeer(dataConnection) {
  var txt = JSON.stringify(dataConnection, null, 4);
  writeToBody(txt);
}

var datt = new Datt({
  onOpen: onOpen,
  onConnection: whenConnectedToPeer,
  onPeers: onPeers,
  onConnectionData: onConnectionData,
  host: document.location.hostname
});

datt.begin();

</script>
</head>
<body>
  <span>P2P prototyping FTW!</span><br><br>
  <span id="status"></span><br><br>
  <span id="peers"></span><br><br>
  <div id="user">
    <form id="userform" onsubmit="return dattLogin();" action="return false;">
      <span>Username:</span><input id="username"/>
      <span>Password:</span><input id="password" type="password"/>
      <input type="submit"/>
    </form>
  </div>
  <div id="addContent">
    <form id="addcontentform" onsubmit="return dattAddContent();" action="return false;">
      <span>Add content:</span><input id="addcontent"/>
      <input type="submit"/>
    </form>
  </div>
  <div id="getLocalContent">
    <form id="getlocalcontentform" onsubmit="return dattGetLocalContent();" action="return false;">
      <span>Get local content:</span><input id="getlocalcontent"/>
      <input type="submit"/>
    </form>
  </div>
  <div id="getRemoteContent">
    <form id="getremotecontentform" onsubmit="return dattGetRemoteContent();" action="return false;">
      <span>Get remote content:</span><input id="getremotecontent"/>
      <input type="submit"/>
    </form>
  </div>
  <div id="getPeersForContent">
    <form id="getpeersforcontentform" onsubmit="return dattGetPeersForContent();" action="return false;">
      <span>Get peers for content:</span><input id="getpeersforcontent"/>
      <input type="submit"/>
    </form>
  </div>
  <br><br>
  <div id="data"></div>
</body>
</html>
